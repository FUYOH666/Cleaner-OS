#!/bin/bash
# System Health Check Script
# Проверка состояния системы для ML/AI разработки
# Универсальная версия для GitHub репозитория

set -euo pipefail

# Определяем путь к скрипту (работает независимо от текущей директории)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

echo "=== System Health Check ==="
echo "Дата: $(date)"
echo ""

# Цвета
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Функция проверки
check_status() {
    local status=$1
    local message=$2
    if [ "$status" -eq 0 ]; then
        echo -e "${GREEN}✓${NC} $message"
    else
        echo -e "${RED}✗${NC} $message"
    fi
}

# 1. GPU проверка
echo "=== GPU Status ==="
if command -v nvidia-smi &> /dev/null; then
    GPU_INFO=$(nvidia-smi --query-gpu=name,temperature.gpu,memory.used,memory.total,utilization.gpu --format=csv,noheader 2>/dev/null)
    if [ $? -eq 0 ]; then
        echo "$GPU_INFO" | while IFS= read -r line; do
            echo "  GPU: $line"
        done
        check_status 0 "GPU доступен"
    else
        check_status 1 "GPU недоступен"
    fi
else
    check_status 1 "nvidia-smi не установлен"
fi
echo ""

# 2. CPU проверка
echo "=== CPU Status ==="
CPU_COUNT=$(nproc 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo "unknown")
CPU_USAGE=$(top -bn1 2>/dev/null | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1}' || echo "unknown")
CPU_GOVERNOR=$(cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor 2>/dev/null || echo "unknown")
echo "  CPU cores: $CPU_COUNT"
echo "  CPU usage: ${CPU_USAGE}%"
echo "  CPU governor: $CPU_GOVERNOR"
if [ "$CPU_GOVERNOR" = "performance" ]; then
    check_status 0 "CPU governor оптимален для ML"
elif [ "$CPU_GOVERNOR" = "unknown" ]; then
    echo "  (CPU governor недоступен на этой системе)"
else
    check_status 1 "CPU governor: $CPU_GOVERNOR (рекомендуется performance)"
fi
echo ""

# 3. Memory проверка
echo "=== Memory Status ==="
if command -v free &> /dev/null; then
    MEM_INFO=$(free -h | grep Mem)
    MEM_TOTAL=$(echo $MEM_INFO | awk '{print $2}')
    MEM_USED=$(echo $MEM_INFO | awk '{print $3}')
    MEM_AVAIL=$(echo $MEM_INFO | awk '{print $7}')
    SWAP_INFO=$(free -h | grep Swap)
    SWAP_USED=$(echo $SWAP_INFO | awk '{print $3}')
    echo "  Total: $MEM_TOTAL"
    echo "  Used: $MEM_USED"
    echo "  Available: $MEM_AVAIL"
    echo "  Swap used: $SWAP_USED"
    if [ "$SWAP_USED" = "0B" ] || [ "$SWAP_USED" = "0" ]; then
        check_status 0 "Swap не используется"
    else
        check_status 1 "Swap используется: $SWAP_USED"
    fi
else
    # macOS
    MEM_INFO=$(vm_stat | perl -ne '/page size of (\d+)/ and $size=$1; /Pages\s+([^:]+)[^\d]+(\d+)/ and print "$1 ".$2*$size/1048576." MB\n"')
    echo "  $MEM_INFO"
fi
echo ""

# 4. Disk проверка
echo "=== Disk Status ==="
if command -v df &> /dev/null; then
    DISK_INFO=$(df -h / | tail -1)
    DISK_USED=$(echo $DISK_INFO | awk '{print $5}' | sed 's/%//')
    DISK_AVAIL=$(echo $DISK_INFO | awk '{print $4}')
    echo "  Root partition: ${DISK_USED}% used, $DISK_AVAIL available"
    if [ "$DISK_USED" -lt 80 ]; then
        check_status 0 "Диск имеет достаточно места"
    else
        check_status 1 "Диск заполнен на ${DISK_USED}%"
    fi
fi
echo ""

# 5. Services проверка
echo "=== Services Status ==="
for service in ssh docker nvidia-persistenced; do
    if systemctl is-active --quiet $service 2>/dev/null; then
        check_status 0 "$service работает"
    else
        check_status 1 "$service не работает"
    fi
done
echo ""

# 6. Python/CUDA проверка
echo "=== Python/CUDA Status ==="
if command -v python3 &> /dev/null; then
    PYTHON_VERSION=$(python3 --version)
    echo "  $PYTHON_VERSION"
    
    CUDA_CHECK=$(python3 -c "import torch; print('CUDA available:', torch.cuda.is_available())" 2>&1)
    if echo "$CUDA_CHECK" | grep -q "CUDA available: True"; then
        check_status 0 "PyTorch CUDA доступен"
        echo "  $CUDA_CHECK"
    else
        check_status 1 "PyTorch CUDA недоступен"
    fi
else
    check_status 1 "Python3 не установлен"
fi
echo ""

# 7. Docker GPU проверка
echo "=== Docker GPU Status ==="
if docker info 2>/dev/null | grep -q "nvidia"; then
    check_status 0 "Docker поддерживает NVIDIA runtime"
else
    check_status 1 "Docker NVIDIA runtime не настроен"
fi
echo ""

echo "=== Health Check Complete ==="

